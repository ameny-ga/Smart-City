services:
  # Service REST - Transport
  service-rest:
    build:
      context: ./service_rest_transport
      dockerfile: Dockerfile
    container_name: smartcity-rest
    ports:
      - "8000:8000"
    networks:
      - smartcity-network
    volumes:
      - ./service_rest_transport/transport.db:/app/data/transport.db
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  # Service SOAP - Air Quality
  service-soap:
    build:
      context: ./service_soap_air
      dockerfile: Dockerfile
    container_name: smartcity-soap
    ports:
      - "8001:8001"
    networks:
      - smartcity-network
    volumes:
      - ./service_soap_air/air_quality.db:/app/data/air_quality.db
    restart: unless-stopped

  # Service GraphQL - Tourisme
  service-graphql:
    build:
      context: ./service_graphql_tourisme
      dockerfile: Dockerfile
    container_name: smartcity-graphql
    ports:
      - "8002:8002"
    networks:
      - smartcity-network
    volumes:
      - ./service_graphql_tourisme/tourisme.db:/app/tourisme.db
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8002/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  # Service gRPC - Urgences
  service-grpc:
    build:
      context: ./service_grpc_urgence
      dockerfile: Dockerfile
    container_name: smartcity-grpc
    ports:
      - "50051:50051"
    networks:
      - smartcity-network
    volumes:
      - ./service_grpc_urgence/urgence.db:/app/data/urgence.db
    restart: unless-stopped

  # API Gateway (Point d'entrée)
  api-gateway:
    build:
      context: ./api_gateway
      dockerfile: Dockerfile
    container_name: smartcity-gateway
    ports:
      - "8888:8080"
    networks:
      - smartcity-network
    environment:
      - OPENWEATHER_API_KEY=${OPENWEATHER_API_KEY}
    env_file:
      - ./api_gateway/.env
    depends_on:
      - service-rest
      - service-soap
      - service-graphql
      - service-grpc
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  # Client Web
  web-client:
    build:
      context: ./web_client
      dockerfile: Dockerfile
    container_name: smartcity-webclient
    ports:
      - "80:80"
    networks:
      - smartcity-network
    depends_on:
      - api-gateway
    restart: unless-stopped

networks:
  smartcity-network:
    driver: bridge
    name: smartcity-network

# Volumes supprimés - Les bases de données sont maintenant des fichiers locaux
# montés directement depuis les dossiers de services
